openapi: 3.1.1
info:
  title: Kickoff Node.js API
  description: RESTful API built with Node.js, Express, TypeScript, and TypeORM
  version: 1.0.0

servers:
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Users
    description: User management operations
  - name: Health
    description: Health check operations
  - name: Pokemon
    description: Pokemon purchase and collection operations
  - name: Mystery Box
    description: Mystery Box operations for random Pokemon

paths:
  /users:
    post:
      tags: [Users]
      summary: Register a new user (Sign Up)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRequest'
            example:
              name: 'John'
              lastName: 'Doe'
              email: 'john.doe@example.com'
              password: 'securePassword123'
      responses:
        '201':
          $ref: '#/components/responses/UserCreated'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/ConflictError'

  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /cards/purchase:
    post:
      tags: [Pokemon]
      summary: Purchase a Pokemon
      description: Purchase a Pokemon by name for the authenticated user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PokemonPurchaseRequest'
            example:
              pokemonName: 'pikachu'
      responses:
        '201':
          $ref: '#/components/responses/PokemonPurchased'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/PokemonNotFoundError'
        '409':
          $ref: '#/components/responses/DuplicatePurchaseError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /cards/collection:
    get:
      tags: [Pokemon]
      summary: Get user's Pokemon collection
      description: Retrieve the authenticated user's purchased Pokemon collection with pagination
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of items per page
      responses:
        '200':
          $ref: '#/components/responses/PokemonCollection'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /mystery-box:
    post:
      tags: [Mystery Box]
      summary: Purchase a Mystery Box
      description: Purchase a Mystery Box for a fixed price and receive a random Pokemon with variable rarity (Common, Uncommon, Rare, Epic, Legendary). The Pokemon's actual value is determined by its weight, height, and types.
      security:
        - BearerAuth: []
      responses:
        '201':
          $ref: '#/components/responses/MysteryBoxPurchased'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/MysteryBoxError'

components:
  schemas:
    UserRequest:
      type: object
      required: [name, lastName, email, password]
      properties:
        name: { type: string, minLength: 1, example: 'John' }
        lastName: { type: string, minLength: 1, example: 'Doe' }
        email: { type: string, format: email, example: 'john.doe@example.com' }
        password: { type: string, minLength: 8, example: 'securePassword123' }

    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: 'John' }
        lastName: { type: string, example: 'Doe' }
        email: { type: string, format: email, example: 'john.doe@example.com' }
        createdAt: { type: string, format: date-time, example: '2025-10-10T14:30:00.000Z' }
        updatedAt: { type: string, format: date-time, example: '2025-10-10T14:30:00.000Z' }

    UserResponse:
      type: object
      properties:
        user: { $ref: '#/components/schemas/User' }

    HealthResponse:
      type: object
      properties:
        status: { type: string, example: 'OK' }
        timestamp: { type: string, format: date-time }

    PokemonPurchaseRequest:
      type: object
      required: [pokemonName]
      properties:
        pokemonName:
          type: string
          minLength: 1
          maxLength: 30
          pattern: '^[a-zA-Z0-9\-]+$'
          example: 'pikachu'
          description: 'Pokemon name (letters, numbers, and hyphens only)'

    PokemonPurchaseResponse:
      type: object
      properties:
        id: { type: integer, example: 1 }
        pokemonId: { type: integer, example: 25 }
        pokemonName: { type: string, example: 'pikachu' }
        pokemonImage:
          {
            type: string,
            format: uri,
            example: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png',
          }
        pokemonTypes: { type: array, items: { type: string }, example: ['electric'] }
        price: { type: number, example: 75 }
        purchasedAt: { type: string, format: date-time, example: '2025-11-07T10:30:00.000Z' }

    MysteryBoxPurchaseResponse:
      type: object
      properties:
        id: { type: integer, example: 10 }
        pokemonId: { type: integer, example: 6 }
        pokemonName: { type: string, example: 'charizard' }
        pokemonImage:
          {
            type: string,
            format: uri,
            example: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png',
          }
        pokemonTypes: { type: array, items: { type: string }, example: ['fire', 'flying'] }
        rarity:
          {
            type: string,
            enum: [common, uncommon, rare, epic, legendary],
            example: 'legendary',
            description: 'Pokemon rarity based on weight',
          }
        price:
          {
            type: number,
            example: 456,
            description: 'Actual value of the Pokemon (calculated from weight, height, types)',
          }
        purchasedAt: { type: string, format: date-time, example: '2025-11-26T15:30:00.000Z' }

    PaginationMetadata:
      type: object
      properties:
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 10 }
        total: { type: integer, example: 25 }
        totalPages: { type: integer, example: 3 }
        hasNext: { type: boolean, example: true }
        hasPrev: { type: boolean, example: false }

    ValidationErrorItem:
      type: object
      properties:
        type: { type: string, example: 'field' }
        value: { type: string, example: 'invalid-email' }
        msg: { type: string, example: 'Invalid email format' }
        path: { type: string, example: 'email' }
        location: { type: string, example: 'body' }

    ErrorResponse:
      type: object
      properties:
        message: { type: string }
        errors:
          type: array
          items: { $ref: '#/components/schemas/ValidationErrorItem' }

  responses:
    UserCreated:
      description: User successfully created
      content:
        application/json:
          schema: { $ref: '#/components/schemas/UserResponse' }
          example:
            user:
              id: 1
              name: 'John'
              lastName: 'Doe'
              email: 'john.doe@example.com'
              createdAt: '2025-10-10T14:30:00.000Z'
              updatedAt: '2025-10-10T14:30:00.000Z'

    ValidationError:
      description: Validation errors in request data
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            message: 'Validation failed'
            errors:
              - type: 'field'
                value: 'invalid-email'
                msg: 'Invalid email format'
                path: 'email'
                location: 'body'

    ConflictError:
      description: Resource already exists
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: 'Email already exists' }
              field: { type: string, example: 'email' }

    PokemonPurchased:
      description: Pokemon successfully purchased
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: "Pokemon 'pikachu' purchased successfully" }
              data: { $ref: '#/components/schemas/PokemonPurchaseResponse' }

    PokemonCollection:
      description: Pokemon collection retrieved successfully
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: 'Pokemon collection retrieved successfully' }
              data:
                type: array
                items: { $ref: '#/components/schemas/PokemonPurchaseResponse' }
              pagination: { $ref: '#/components/schemas/PaginationMetadata' }

    PokemonNotFoundError:
      description: Pokemon not found in PokeAPI
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: "Pokemon 'invalidname' does not exist" }

    DuplicatePurchaseError:
      description: Pokemon already purchased by user
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: 'You have already purchased pikachu' }

    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: 'Authentication required to purchase Pokemon' }

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: 'Failed to fetch data from PokeAPI' }

    MysteryBoxPurchased:
      description: Mystery Box successfully purchased, random Pokemon obtained
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                {
                  type: string,
                  example: 'Congratulations! You got a legendary Pokemon!',
                  description: 'Success message indicating the rarity of the Pokemon obtained',
                }
              data: { $ref: '#/components/schemas/MysteryBoxPurchaseResponse' }
          example:
            message: 'Congratulations! You got a legendary Pokemon!'
            data:
              id: 10
              pokemonId: 6
              pokemonName: 'charizard'
              pokemonImage: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png'
              pokemonTypes: ['fire', 'flying']
              rarity: 'legendary'
              price: 456
              purchasedAt: '2025-11-26T15:30:00.000Z'

    MysteryBoxError:
      description: Error during Mystery Box purchase
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                {
                  type: string,
                  example: 'Failed to complete mystery box purchase',
                  description: 'Error message indicating what went wrong',
                }

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
